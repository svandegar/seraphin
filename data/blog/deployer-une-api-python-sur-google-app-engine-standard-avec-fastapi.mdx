---
title: 'D√©ployer une API Python sur Google App Engine Standard, avec FastAPI.'
date: '2021-01-18'
tags:
  - D√©veloppement
  - H√©bergement
draft: false
author: default
images:
  - /static/images/default-card.png
summary: "Aujourd'hui, j'ai appris qu'une mise √† jour des conditions d'utilisation de WhatsApp provoquait la col√®re des utilisateurs et utilisatrices. WhatsApp pourrait √† pr√©sent acc√©der au contenu de nos conversations pour les lire, les analyser et vendre nos pr√©cieuses donn√©es aux entreprises partenaires de Facebook"
---

> Cet article a √©t√© initialement publi√© en 2021 sur le site de mon entreprise [Aynils](https://aynils.ca). Je l'ai d√©plac√© car √ßa fait plus de sens de m'exprimer en mon nom propre ici.
> J'√©vite mainenant d'utiliser les services de Google mais cet article reste pertinent pour celleux qui n'ont pas le choix, dans le cadre d'un projet.

<TOCInline toc={props.toc} toHeading={2} asDisclosure={true} />

[Google App Engine Standard](https://cloud.google.com/appengine/docs/the-appengine-environments) (GAE) √©tait mon service pr√©f√©r√© (avant ma r√©flexion sur le monopole malsain des GAFAM) pour le d√©ploiement de mes services Python et Node.js. En plus de la g√©n√©rosit√© de son offre gratuite, j'aime GAE pour ces avantages:

- Scaling automatique ;
- Portail d'administration clair ;
- D√©ploiement simple, en une seule commande ;
- √âcosyst√®me Google Cloud Portal permettant d'acc√©der simplement √† toute une s√©rie de services compl√©mentaires: Pub/Sub, Cron tasks, DB manag√©e, AI APIs, etc.

√Ä c√¥t√© de ces avantages, le point n√©gatif des services de Google est souvent la pr√©cision de la documentation. Quand j'utilise un nouveau service, je dois souvent passer beaucoup de temps √† chercher des r√©ponses √† mes questions et quand j'en trouve, elles ne sont pas toujours √† jour.

J'ai donc d√©cid√© de contribuer √† am√©liorer la situation en publiant ce guide pour d√©ployer une API Python sur Google App Engine Standard.

## Pr√©requis

- Un acc√®s _owner_ √† un compte Google Cloud Portal ([GCP](https://www.google.com/search?client=ubuntu&hs=ip&channel=fs&ei=X4QRYNXBE5uEwbkP-cimqAk&q=google+cloud+portal&oq=google+cloud+portal&gs_lcp=CgZwc3ktYWIQAzICCAAyBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjoECAAQRzoECAAQQzoHCAAQsQMQQzoFCAAQsQNQxxNY6Rxg3B5oAHACeACAAVuIAewHkgECMTKYAQCgAQGqAQdnd3Mtd2l6yAEIwAEB&sclient=psy-ab&ved=0ahUKEwiV7d3QtLzuAhUbQjABHXmkCZUQ4dUDCAw&uact=5));
- [Python 3.8](https://www.python.org/downloads/release/python-380/) install√© sur ta machine;
- Un d√©p√¥t [GitHub](https://www.github.com) pour ton projet.

## Conventions

Les instructions sont test√©es depuis Linux (Ubuntu 20.04.1 LTS) et devraient fonctionner √©galement sous Mac OS. Si tu utilises Windows, d√©sol√© mais il faudra un peu adapter.

Quand une ligne de code commence par `$`, cela signifie qu'elle doit √™tre entr√©e dans ton terminal. Le `$` ne doit jamais √™tre entr√© avec la commande qui suit.

## L'API

Tout d‚Äôabord, commen√ßons par d√©velopper une API simple, pour les besoins de cet exercice. Si tu as d√©j√† une application pr√™te √† √™tre d√©ploy√©e, tu peux directement aller √† l'√©tape suivante: Configuration

### Cr√©ation de la base du projet

Pour partir d'un environnement Python propre, cr√©e d'abord un nouveau dossier et acc√©des-y.

`$ mkdir ma-super-api && cd ma-super-api`

Cr√©e un environnement virtuel.

`$ python3.8 -m venv venv`

Maintenant, tu as besoin d'un fichier `requirements.txt` pour sp√©cifier les packages √† importer.

`$ touch requirements.txt`

Et le fichier qui contiendra le code de notre API.

`$ touch main.py`

### Le code

Pour ce guide, j'ai choisi de cr√©er une API simple, en utilisant le package [FastAPI](https://fastapi.tiangolo.com/). Qui permet de d√©velopper rapidement des API Python asynchrones.

#### L'environement

Depuis `/ma-super-api/` :

Acc√®de √† l'environnement virtuel:

`$ source venv/bin/activate`

Si l'action √† fonctionn√©, tu verras `(venv)` indiqu√© devant ton nom d'utilisateur, dans le terminal. Toutes les actions effectu√©es √† partir de maintenant le seront depuis le contexte de cet [environnement virtuel](https://docs.python.org/3/library/venv.html).

Documente les packages √† installer dans le fichier `requirements.txt`

```
fastapi
uvicorn
gunicorn
uvloop
httptools
websockets
```

Puis installe les packages document√©s

`$ pip install -r requirements.txt`

#### Le code

Ouvre le fichier [main.py](http://main.py) dans ton √©diteur favori et colles-y le code suivant:

```python
import os
import uvicorn
from fastapi import FastAPI

app = FastAPI()

@app.get("/salut")
async def getCity():
    return {
        "message": "Hey, salut!"
    }

if __name__ == "__main__" and os.environ.get("ENVIRONMENT") != "PRODUCTION":
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

Tu peux maintenant tester le r√©sultat localement

`$ python main.py`

Le message suivant devrait √™tre affich√© dans ton terminal:

```console
INFO:     Started server process [20686]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

Et si tu ouvres ton navigateur et navigues √† l'adresse [`http://0.0.0.0:8000/salut`](http://0.0.0.0:8000/salut), tu y verras le r√©sultat suivant:

```python
{"message":"Hey, salut!"}
```

Si √ßa marche, tu peux arr√™ter le serveur en appuyant sur `CTRL + C` puis sortir de l‚Äôenvironnement virtuel `$ deactivate`

## Configuration

#### Git

Il te faut un d√©p√¥t git local, synchronis√© avec le d√©p√¥t GitHub de ce projet.

`$ git init`

`$ git remote add origin <URL_DE_TON_DEPOT_GITHUB>`

Et un gitignore pour ne pas synchroniser ton environnement virtuel avec le d√©p√¥t.

`$ echo "venv" > .gitignore`

#### Google App Engine

##### Cr√©ation de l'app

Ouvre le [portal de Google App Engine](https://console.cloud.google.com/appengine) et clique sur `Cr√©er une application`. Choisis les options suivantes:

- Localisation: choisis le serveur le plus pr√®s des services qui utiliseront l'API
- Langage: `Python`
- Environnement: `Standard`

A l'√©tape `D√©ployer avec le SDK Google Cloud`, clique sur `Je le ferai plus tard`

##### Activation de Cloud build API

Ouvre le [portail Cloud Build](https://console.developers.google.com/apis/api/cloudbuild.googleapis.com/overview?) et clique sur `Activer`

##### Configuration de l'API

La configuration de l'instance Google App Engine sur laquelle ton API sera d√©ploy√©e se trouve dans le fichier `app.yaml`, d√©ploy√© avec ton application. Cr√©e ce fichier:

`$ touch app.yaml`

Ensuite, ajoutes-y le contenu suivant:

```yaml
runtime: python38

entrypoint: gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker

instance_class: F2

env_variables:
  ENVIRONMENT: "PRODUCTION

handlers:
- url: /.*
  secure: always
  redirect_http_response_code: 301
  script: auto
```

La documentation concernant ce fichier est disponible [ici](https://cloud.google.com/appengine/docs/standard/python3/config/appref)

##### Compte de service

Pour cr√©er l'instance Google App Engine et y d√©ployer l'API, tu as besoin d'un compte de service. Pour le cr√©er, √ßa se passe dans [la section IAM de ton compte Google Cloud Portal](https://console.cloud.google.com/iam-admin/serviceaccounts), onglet "Comptes de service".

Clique sur `Cr√©er un compte de service` dans la barre sup√©rieure et remplisse les diff√©rents champs de l'√©tape 1 `D√©tails du compte de service` avec les donn√©es suivantes:

- Nom du compte de service: `github-action`
- ID du compte de service: laisser la valeur par d√©faut
- Description du compte de service: `Compte utilis√© par GitHub actions pour g√©rer les instances`

A l'√©tape 2 `Autoriser ce compte de service √† acc√©der au projet`, ajoute les r√¥les suivants:

- D√©ployeur App¬†Engine
- Administrateur de services App¬†Engine
- √âditeur Cloud¬†Build
- Utilisateur du compte de service
- Cr√©ateur des objets de l'espace de stockage
- Lecteur des objets de l'espace de stockage

N'entre rien √† l'√©tape 3 `Autoriser les utilisateurs √† acc√©der √† ce compte de service` et clique sur `OK` pour valider.

Ensuite, ouvre le menu en cliquant sur les trois points dans la colonne tout √† droite de la ligne correspondant au compte de service nouvellement cr√©√© et choisis l'option `cr√©er une cl√©`.

Choisir `json` et enregistrer le fichier localement. ‚ö†Ô∏èCette cl√© permet d'acc√©der √† ton compte et doit donc √™tre stock√©e en s√©curit√©.

Pour utiliser la cl√© pour le d√©ploiement, tu as besoin de sa repr√©sentation en base 64. Pour ce faire, ouvre ton terminal dans le dossier ou se trouve la cl√© que tu viens de t√©l√©charger et utilise la commande suivante:

`$ base64 <NOM_DU_FICHIER_DE_CLE>`

Copier le r√©sultat et le conserver pour l'√©tape suivante.

#### GitHub

##### Secret

Dans ton compte GitHub, aller navigue vers le d√©p√¥t de ce projet puis ouvre la page `Settings` puis l'onglet `Secrets`.

Cr√©e un nouveau _secret_ en cliquant sur `New repository secret` avec les donn√©es suivantes:

- Name: `GAE_DEPLOY_KEY`
- Value: copie ici la repr√©sentation base64 de ta cl√© que tu viens de cr√©er √† l'√©tape pr√©c√©dente

##### Action

La configuration se trouve dans un fichier `.yaml` √† cr√©er dans le projet.

`$ mkdir -p .github/workflows/`

`$ touch .github/workflows/gae.yaml`

Ouvre le fichier et y ajoutes-y la configuration suivante:

```yaml
name: Deploy to Google App Engine

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        uses: google-github-actions/deploy-appengine@main
        with:
          credentials: ${{ secrets.GAE_DEPLOY_KEY }}
          deliverables: app.yaml
```

## D√©ploiement

√áa y est, c'est le moment de d√©ployer ton API! ü•≥

Premi√®rement, commit tes changements localement

`$ git add .`

`$ git commit -m "initial commit"`

Et puis, pousse les changements vers le d√©p√¥t distant GitHub.

`$ git branch -M main` ‚ùóCette √©tape sert √† renommer la branche `master` cr√©e par d√©faut localement vers `main` qui est le [nouveau nom de la branche principale](https://github.blog/changelog/2020-10-01-the-default-branch-for-newly-created-repositories-is-now-main/) sur GitHub

`$ git push -u origin main`

Maintenant, tout est pr√™t. Il ne te reste plus qu'√† tester. Pour cela, il faut un changement pour pouvoir pousser √† nouveau vers GitHub et d√©clencher l'action qui √† √©t√© cr√©√©e √† l'√©tape pr√©c√©dente.

`$ touch README.MD`

`$ git add .`

`$ git commit -m "add README"`

`$ git push`

## Test

Pour v√©rifier le statut du d√©ploiement, √ßa se passe sur GitHub, sur la page du d√©p√¥t du projet, dans l'onglet `Actions`.

Si c'est vert, c'est bon. Si c'est rouge, c'est pas bon. (merci Captain Obvious!).

Pour acc√©der √† l'API, il te reste √† trouver son url. Elle se trouve sur le [portail Google App Engine](https://console.cloud.google.com/appengine), en haut √† droite. Elle ressemble √† `<NOM_DE_TON_PROJET>.uc.r.appspot.com`

Ouvre ton navigateur et navigues vers `<URL_DE_TON_APP_ENGINE>/salut` et tu devrais voir le r√©sultat:

```yaml
{ 'message': 'Hey, salut!' }
```

Et voil√†! ‚ú®
